<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Lista - Sistema Cloud Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --netflix-red: #E50914;
            --bg-black: #141414;
            --card-gray: #1f1f1f;
            --star-color: #f1c40f;
            --type-green: #2ecc71;
        }

        body {
            background-color: var(--bg-black); color: white;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0; padding-top: 230px;
        }

        header {
            background-color: rgba(0,0,0,0.95); position: fixed;
            top: 0; width: 100%; z-index: 1000; padding: 20px 4%;
            box-sizing: border-box; border-bottom: 1px solid #333;
        }

        .header-main { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: var(--netflix-red); font-size: 1.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        nav { display: flex; gap: 15px; }

        .nav-link {
            color: #aaa; text-decoration: none; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; padding: 5px 10px; border-radius: 4px;
        }
        .nav-link.active { color: white; background: var(--netflix-red); }

        .filter-bar {
            display: flex; gap: 10px; background: rgba(255,255,255,0.05);
            padding: 15px; border-radius: 8px; align-items: center; flex-wrap: wrap;
        }
        .filter-bar input, .filter-bar select {
            background: #333; border: 1px solid #555; color: white;
            padding: 10px; border-radius: 4px; outline: none; font-size: 0.9rem;
        }

        #searchInput { flex: 2; min-width: 200px; }
        .admin-controls { display: flex; gap: 10px; }
        
        /* Estilos base de Admin */
        #migrationBtn, #tmdbUpdateBtn, #normalizeBtn { padding: 10px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; border: none; color: white; }
        #migrationBtn { background: #f39c12; }
        #tmdbUpdateBtn { background: #3498db; }
        #normalizeBtn { background: #8e44ad; }
        .btn-add { background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        main { padding: 0 4% 50px 4%; }
        .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 25px; }

        .movie-card {
            background: var(--card-gray); border-radius: 8px; overflow: hidden;
            position: relative; min-height: 520px; display: flex;
            flex-direction: column; transition: transform 0.2s;
        }
        .movie-card:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        .movie-poster-container {
            width: 100%; height: 310px; background: #333;
            display: flex; align-items: center; justify-content: center;
            color: #555; font-size: 3rem; position: relative;
        }

        .badge-new {
            position: absolute; top: 10px; left: 10px; background: var(--netflix-red);
            color: white; padding: 4px 8px; font-size: 0.7rem; font-weight: bold;
            border-radius: 4px; z-index: 4; text-transform: uppercase;
        }

        .movie-poster { width: 100%; height: 100%; object-fit: contain; background-color: var(--card-gray); }
        .movie-info { padding: 15px; display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .movie-title { font-weight: bold; font-size: 1rem; margin-top: 5px; height: 2.8em; overflow: hidden; }
        .tag { color: var(--type-green); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }

        .star-rating { margin-top: 5px; display: flex; align-items: center; margin-bottom: 10px; }
        .stars-outer { position: relative; color: #444; font-size: 0.9rem; }
        .stars-inner { position: absolute; top: 0; left: 0; overflow: hidden; width: 0; color: var(--star-color); white-space: nowrap; }
        .rating-number { font-weight: bold; color: var(--star-color); margin-left: 8px; font-size: 0.9rem; }

        .movie-review { font-size: 0.85rem; color: #ccc; font-style: italic; border-top: 1px solid #333; padding-top: 10px; margin-top: 5px; line-height: 1.4; word-wrap: break-word; }

        .btn-trailer {
            background-color: var(--netflix-red); color: white; border: none;
            padding: 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 8px; margin-top: 15px; transition: background 0.3s; width: 100%;
        }
        .btn-trailer:hover { background-color: #ff0f1a; }

        .btn-delete {
            position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7);
            border: none; color: #fff; cursor: pointer; padding: 8px; border-radius: 50%;
            opacity: 0; transition: opacity 0.2s; z-index: 5;
        }
        .movie-card:hover .btn-delete { opacity: 1; }

        #modal, #trailerModal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #181818; padding: 30px; border-radius: 8px;
            width: 90%; max-width: 450px; display: flex; flex-direction: column; gap: 15px;
        }
        .trailer-content { width: 90%; max-width: 800px; aspect-ratio: 16/9; position: relative; }
        #trailerFrame { width: 100%; height: 100%; border: none; border-radius: 8px; }
        .close-trailer { position: absolute; top: -40px; right: 0; color: white; cursor: pointer; font-size: 1.2rem; font-weight: bold; }

        @media (max-width: 768px) {
            body { padding-top: 210px; }
            .movie-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
            .movie-card { min-height: 450px; }
            .movie-poster-container { height: 220px; }
        }

        --- BLOQUEIO ATIVO DE ADMINISTRAÇÃO --- */
        #migrationBtn, 
        #tmdbUpdateBtn, 
        #normalizeBtn, 
        .btn-add, 
        .btn-delete { 
            display: none !important;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-main">
            <h1>MINHA LISTA</h1>
            <nav>
                <div class="nav-link active" onclick="window.switchTab('filmes', this)">Filmes</div>
                <div class="nav-link" onclick="window.switchTab('series', this)">Séries</div>
                <div class="nav-link" onclick="window.switchTab('animacoes', this)">Animações</div>
            </nav>
            <button class="btn-add" onclick="window.openModal()">+ ADICIONAR</button>
        </div>
        <div class="filter-bar">
            <input type="text" id="searchInput" placeholder="Pesquisar título..." oninput="window.applyFilters()">
            <select id="typeFilter" onchange="window.applyFilters()"><option value="">Todos os Tipos</option></select>
            <select id="ratingFilter" onchange="window.applyFilters()">
                <option value="0">Classificações</option>
                <optgroup label="Ordenar">
                    <option value="high-low">Melhores (A-Z)</option>
                    <option value="low-high">Piores (A-Z)</option>
                </optgroup>
                <optgroup label="Filtrar">
                    <option value="5">Nota 5</option>
                    <option value="4">4.0 a 4.9</option>
                    <option value="3">3.0 a 3.9</option>
                    <option value="2">2.0 a 2.9</option>
                </optgroup>
            </select>
            <div class="admin-controls">
                <button id="migrationBtn" onclick="window.migrateToFirebase()">MIGRAR</button>
                <button id="tmdbUpdateBtn" onclick="window.updateAllPosters()">POSTERS</button>
                <button id="normalizeBtn" onclick="window.normalizeDatabase()">PADRONIZAR BANCO</button>
            </div>
        </div>
    </header>

    <div id="trailerModal" onclick="window.closeTrailer()">
        <div class="trailer-content" onclick="event.stopPropagation()">
            <span class="close-trailer" onclick="window.closeTrailer()"><i class="fas fa-times"></i> Fechar Janela</span>
            <iframe id="trailerFrame" src="" allowfullscreen allow="autoplay"></iframe>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 style="color: var(--netflix-red); margin: 0;">Nova Obra</h2>
            <input type="text" id="newTitle" placeholder="Título">
            <input type="text" id="newType" placeholder="Tipo">
            <input type="number" id="newRating" placeholder="Nota" step="0.25">
            <input type="text" id="newTrailerUrl" placeholder="URL do Trailer YouTube">
            <textarea id="newReview" placeholder="Seu relato..." rows="4"></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="window.closeModal()" style="flex:1; padding:10px; background:#444; border:none; color:white;">Cancelar</button>
                <button onclick="window.saveEntry()" style="flex:1; padding:10px; background:var(--netflix-red); color:white;">Salvar</button>
            </div>
        </div>
    </div>

    <main>
        <p id="stats" style="font-weight: bold; color: #888;">Carregando...</p>
        <div class="movie-grid" id="movie-grid"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4QIzbdBZB8IUloK6KPlMrBZ83BTYzc9Q",
            authDomain: "listaaudiovisual.firebaseapp.com",
            projectId: "listaaudiovisual",
            storageBucket: "listaaudiovisual.firebasestorage.app",
            messagingSenderId: "790211725412",
            appId: "1:790211725412:web:2b3330d88dc1920ddb7771"
        };
        const TMDB_API_KEY = "d09c3aec764d2a8d3307a3f96517ac15";

        const app = initializeApp(firebaseConfig);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true });

        let dataStore = { filmes: [], series: [], animacoes: [] };
        let currentTab = 'filmes';

        window.normalizeDatabase = async () => {
            if(!confirm("Deseja padronizar o banco?")) return;
            const collections = ['filmes', 'series', 'animacoes'];
            for (const colName of collections) {
                const querySnapshot = await getDocs(collection(db, colName));
                for (const d of querySnapshot.docs) {
                    const data = d.data();
                    const updates = {};
                    if (data.trailerUrl === undefined) updates.trailerUrl = "";
                    if (data.timestamp === undefined) updates.timestamp = Date.now();
                    if (Object.keys(updates).length > 0) await updateDoc(doc(db, colName, d.id), updates);
                }
            }
            alert("Padronizado!"); location.reload();
        };

        function formatYoutubeLink(url) {
            if (!url) return null;
            let videoId = "";
            if (url.includes("v=")) videoId = url.split("v=")[1].split("&")[0];
            else if (url.includes("youtu.be/")) videoId = url.split("youtu.be/")[1].split("?")[0];
            else if (url.includes("embed/")) return url;
            return videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1` : url;
        }

        window.watchTrailer = async (title, type, manualUrl) => {
            const frame = document.getElementById('trailerFrame');
            if (manualUrl && manualUrl.trim() !== "") {
                frame.src = formatYoutubeLink(manualUrl);
                document.getElementById('trailerModal').style.display = 'flex';
                return;
            }
            document.getElementById('stats').innerText = "Buscando automático...";
            const cat = (type === 'series') ? 'tv' : 'movie';
            const cleanTitle = title.split('(')[0].split('–')[0].trim();
            try {
                const resSearch = await fetch(`https://api.themoviedb.org/3/search/${cat}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanTitle)}&language=pt-BR`);
                const dataSearch = await resSearch.json();
                if (dataSearch.results[0]) {
                    const id = dataSearch.results[0].id;
                    const resVid = await fetch(`https://api.themoviedb.org/3/${cat}/${id}/videos?api_key=${TMDB_API_KEY}`);
                    const dataVid = await resVid.json();
                    const trailer = dataVid.results.find(v => v.type === 'Trailer' && v.site === 'YouTube') || dataVid.results[0];
                    if (trailer) {
                        frame.src = `https://www.youtube.com/embed/${trailer.key}?autoplay=1`;
                        document.getElementById('trailerModal').style.display = 'flex';
                    } else { alert("Não encontrado."); }
                }
            } catch (err) { alert("Erro."); }
            document.getElementById('stats').innerText = `${currentTab.toUpperCase()} (${dataStore[currentTab].length})`;
        };

        window.closeTrailer = () => { document.getElementById('trailerModal').style.display = 'none'; document.getElementById('trailerFrame').src = ""; };

        function renderData(filterData = null, sortType = 'alpha') {
            let itemsToRender = filterData ? [...filterData] : [...dataStore[currentTab]];
            itemsToRender.sort((a, b) => {
                if (sortType === 'high-low') return (b.rating - a.rating) || a.title.localeCompare(b.title);
                if (sortType === 'low-high') return (a.rating - b.rating) || a.title.localeCompare(b.title);
                return a.title.localeCompare(b.title);
            });
            const g = document.getElementById('movie-grid');
            const htmlBuffer = [];
            const TRINTA_DIAS = 30 * 24 * 60 * 60 * 1000;
            itemsToRender.forEach(item => {
                const p = (item.rating/5)*100;
                const badge = (item.timestamp && (Date.now() - item.timestamp < TRINTA_DIAS)) ? `<div class="badge-new">Novo!</div>` : '';
                const reviewHtml = item.review ? `<div class="movie-review">"${item.review}"</div>` : '';
                htmlBuffer.push(`
                    <div class="movie-card">
                        ${badge}
                        <button class="btn-delete" onclick="window.deleteItem('${item.fireId}')"><i class="fas fa-trash"></i></button>
                        <div class="movie-poster-container">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" class="movie-poster" loading="lazy">` : `<i class="fas fa-film"></i>`}
                        </div>
                        <div class="movie-info">
                            <div>
                                <div class="tag">${item.type}</div>
                                <div class="movie-title">${item.title}</div>
                                <div class="star-rating">
                                    <div class="stars-outer"><div class="stars-inner" style="width:${p}%">★★★★★</div>★★★★★</div>
                                    <span class="rating-number">${item.rating}</span>
                                </div>
                                ${reviewHtml}
                            </div>
                            <button class="btn-trailer" onclick="window.watchTrailer('${item.title.replace(/'/g, "\\'")}', '${currentTab}', '${item.trailerUrl || ''}')">
                                <i class="fas fa-play"></i> Assistir Trailer
                            </button>
                        </div>
                    </div>
                `);
            });
            g.innerHTML = htmlBuffer.join('');
            document.getElementById('stats').innerText = `${currentTab.toUpperCase()} (${itemsToRender.length})`;
        }

        window.fetchFromFirebase = async () => {
            try {
                const s = await getDocs(collection(db, currentTab));
                const l = []; s.forEach(d => l.push({ fireId: d.id, ...d.data() }));
                dataStore[currentTab] = l;
                updateTypeDropdown(); renderData();
            } catch (e) { }
        };

        window.applyFilters = () => {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const selectedType = document.getElementById('typeFilter').value;
            const ratingValue = document.getElementById('ratingFilter').value;
            let sortMode = (ratingValue === 'high-low' || ratingValue === 'low-high') ? ratingValue : 'alpha';
            let ratingBase = (!isNaN(ratingValue)) ? parseFloat(ratingValue) : 0;
            const filtered = dataStore[currentTab].filter(item => {
                const matchesSearch = item.title.toLowerCase().includes(searchText);
                let matchesRating = ratingBase > 0 ? (ratingBase === 5 ? item.rating === 5 : (item.rating >= ratingBase && item.rating < ratingBase + 1)) : true;
                let matchesType = selectedType === "" || (item.type && item.type.split('/').map(t => t.trim()).includes(selectedType));
                return matchesSearch && matchesRating && matchesType;
            });
            renderData(filtered, sortMode);
        };

        function updateTypeDropdown() {
            const typeSelect = document.getElementById('typeFilter');
            const allTypes = new Set();
            dataStore[currentTab].forEach(item => { if (item.type) item.type.split('/').forEach(t => allTypes.add(t.trim())); });
            typeSelect.innerHTML = '<option value="">Todos os Tipos</option>';
            Array.from(allTypes).sort().forEach(t => { typeSelect.innerHTML += `<option value="${t}">${t}</option>`; });
        }

        window.switchTab = async (t, e) => {
            currentTab = t;
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            e.classList.add('active');
            await fetchFromFirebase();
        };

        window.saveEntry = async () => {
            const title = document.getElementById('newTitle').value;
            const type = document.getElementById('newType').value;
            const rating = parseFloat(document.getElementById('newRating').value);
            const review = document.getElementById('newReview').value;
            const trailerUrl = document.getElementById('newTrailerUrl').value;
            if(title && type && !isNaN(rating)) {
                const resSearch = await fetch(`https://api.themoviedb.org/3/search/${currentTab === 'series' ? 'tv' : 'movie'}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&language=pt-BR`);
                const data = await resSearch.json();
                const img = data.results[0] ? `https://image.tmdb.org/t/p/w500${data.results[0].poster_path}` : "";
                await addDoc(collection(db, currentTab), { title, type, rating, imageUrl: img, review, trailerUrl, timestamp: Date.now() });
                window.closeModal(); await fetchFromFirebase();
            }
        };

        window.deleteItem = async (id) => { if(confirm("Excluir?")) { await deleteDoc(doc(db, currentTab, id)); await fetchFromFirebase(); } };
        window.openModal = () => document.getElementById('modal').style.display = 'flex';
        window.closeModal = () => { document.getElementById('modal').style.display = 'none'; };

        fetchFromFirebase();
    </script>
</body>
</html>





